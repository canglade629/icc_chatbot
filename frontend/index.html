<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ICC Legal Research Assistant</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Session Management -->
    <script src="/js/session-manager.js"></script>
    <script src="/js/session-timeout-warning.js"></script>
    <script src="/js/session-status-indicator.js"></script>
    <style>
        .typing-dots {
            display: inline-block;
        }
        .typing-dots::after {
            content: '';
            animation: typing 1.5s infinite;
        }
        @keyframes typing {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        .scroll-smooth {
            scroll-behavior: smooth;
        }
        
        /* Simple markdown styling */
        .markdown-content {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            color: #374151;
            background-color: transparent;
        }
        
        .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            font-weight: bold;
            margin: 0.75rem 0 0.25rem 0;
        }
        
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.25rem; }
        .markdown-content h3 { font-size: 1.125rem; }
        .markdown-content h4 { font-size: 1rem; }
        .markdown-content h5 { font-size: 0.875rem; }
        .markdown-content h6 { font-size: 0.875rem; }
        
        .markdown-content p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .markdown-content li {
            margin: 0.25rem 0;
        }
        
        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .markdown-content pre {
            background-color: #f3f4f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 0.5rem 0;
            font-style: italic;
            color: #6b7280;
        }
        
        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        
        .markdown-content a:hover {
            color: #1d4ed8;
        }
        
        .markdown-content strong, .markdown-content b {
            font-weight: bold;
        }
        
        .markdown-content em, .markdown-content i {
            font-style: italic;
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.5rem 0;
        }
        
        .markdown-content th, .markdown-content td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .markdown-content th {
            background-color: #f9fafb;
            font-weight: bold;
        }
        
        /* Simple dark mode support */
        [data-theme="dark"] {
            .markdown-content {
                color: #ffffff;
            }
            
            .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 {
                color: #ffffff;
            }
            
            .markdown-content code {
                background-color: #374151;
                color: #ffffff;
            }
            
            .markdown-content pre {
                background-color: #374151;
                color: #ffffff;
            }
            
            .markdown-content blockquote {
                border-left-color: #6b7280;
                color: #ffffff;
            }
            
            .markdown-content th {
                background-color: #4b5563;
                color: #ffffff;
            }
            
            .markdown-content td {
                border-bottom-color: #6b7280;
            }
        }
        
        .markdown-content li {
            margin: 0.25rem 0;
        }
        
        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .markdown-content pre {
            background-color: #f3f4f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 0.5rem 0;
            font-style: italic;
            color: #6b7280;
        }
        
        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        
        .markdown-content a:hover {
            color: #1d4ed8;
        }
        
        .markdown-content strong, .markdown-content b {
            font-weight: bold;
        }
        
        .markdown-content em, .markdown-content i {
            font-style: italic;
        }
        
        /* Strong and em styling moved to legal-specific section below */
        
        /* Legal-specific styling */
        .markdown-content code {
            background-color: #f1f5f9 !important; /* Very light grey background for Articles */
            color: #475569 !important; /* Medium grey text */
            padding: 0.125rem 0.375rem !important; /* Smaller padding */
            border-radius: 0.25rem !important; /* Smaller border radius */
            font-family: 'Courier New', monospace !important;
            font-size: 0.8rem !important; /* Smaller font size */
            font-weight: 500 !important; /* Lighter font weight */
            border: none !important; /* No border */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important; /* Subtle shadow */
        }
        
        /* Harmonized strong/bold text - grey tones */
        .markdown-content strong, .markdown-content b {
            font-weight: 700 !important;
            color: #111827; /* Darkest grey for bold text */
        }
        
        /* Harmonized paragraph styling - grey tones */
        .markdown-content p {
            margin: 0.75rem 0 !important;
            line-height: 1.6 !important;
            color: #4b5563; /* Medium grey for paragraphs */
        }
        
        /* Enhanced legal citations formatting */
        .markdown-content h2 {
            color: #1f2937 !important;
            font-size: 1.25rem !important;
            font-weight: 700 !important;
            margin: 1.5rem 0 1rem 0 !important;
            padding-bottom: 0.5rem !important;
            border-bottom: 2px solid #e5e7eb !important;
        }
        
        /* List styling */
        .markdown-content ul, .markdown-content ol {
            margin: 1rem 0 !important;
            padding-left: 1.5rem !important;
        }
        
        .markdown-content ul li, .markdown-content ol li {
            margin: 0.5rem 0 !important;
            line-height: 1.5 !important;
        }
        
        /* Page reference styling within citations */
        .markdown-content ol li p {
            margin: 0.25rem 0 !important;
            font-size: 0.875rem !important;
            color: #6b7280 !important;
            font-style: italic !important;
        }
        
        /* Legal headings */
        .markdown-content h1 {
            color: #1f2937 !important;
            border-bottom: 2px solid #e5e7eb !important;
            padding-bottom: 0.5rem !important;
            margin-bottom: 1rem !important;
        }
        
        .markdown-content h2 {
            color: #374151 !important;
            margin-top: 1.5rem !important;
            margin-bottom: 0.75rem !important;
        }
        
        .markdown-content h3 {
            color: #4b5563 !important;
            margin-top: 1.25rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        
        /* Enhanced blockquotes for legal citations and insights */
        .markdown-content blockquote {
            border-left: 4px solid #3b82f6 !important;
            background-color: #f8fafc !important;
            padding: 1rem !important;
            margin: 1rem 0 !important;
            border-radius: 0.375rem !important;
            color: #374151 !important;
            font-style: italic !important;
            position: relative !important;
        }
        
        .markdown-content blockquote::before {
            content: "💡" !important;
            position: absolute !important;
            top: -0.5rem !important;
            left: -0.5rem !important;
            background: #3b82f6 !important;
            color: white !important;
            border-radius: 50% !important;
            width: 1.5rem !important;
            height: 1.5rem !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 0.75rem !important;
        }
        
        /* Harmonized italic text - grey tones */
        .markdown-content em, .markdown-content i {
            color: #6b7280 !important; /* Light grey for italic text */
            font-style: italic !important;
        }
        
        /* Custom legal element classes */
        .legal-article {
            background-color: #f1f5f9 !important; /* Very light grey background */
            color: #475569 !important; /* Medium grey text */
            padding: 0.125rem 0.375rem !important; /* Smaller padding */
            border-radius: 0.25rem !important; /* Smaller border radius */
            font-family: 'Courier New', monospace !important;
            font-size: 0.8rem !important; /* Smaller font size */
            font-weight: 500 !important; /* Lighter font weight */
            border: none !important; /* No border */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important; /* Subtle shadow */
            white-space: nowrap !important; /* Prevent line breaks within article boxes */
            display: inline-block !important; /* Keep as inline element */
        }
        
        /* Harmonized legal elements - grey tones */
        .legal-case {
            color: #374151 !important; /* Medium grey for case names */
            font-weight: 700 !important;
            font-size: 0.95em !important;
        }
        
        .legal-page {
            color: #6b7280 !important; /* Light grey for page references */
            font-style: italic !important;
            font-size: 0.9em !important;
        }
        
        /* Harmonized list items - grey tones */
        .legal-list-item {
            margin: 0.75rem 0 !important;
            line-height: 1.6 !important;
            padding: 0.5rem 0 0.5rem 1rem !important;
            border-left: 4px solid #9ca3af !important; /* Light grey left border */
            background: none !important; /* No background */
            color: #4b5563 !important; /* Medium grey for list items */
        }
        
        /* Harmonized table styling - grey tones */
        .markdown-content table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin: 1rem 0 !important;
            background-color: #ffffff !important;
            border-radius: 0.5rem !important;
            overflow: hidden !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }
        
        .markdown-content th {
            background-color: #6b7280 !important; /* Medium grey for headers */
            color: #ffffff !important;
            padding: 0.75rem !important;
            text-align: left !important;
            font-weight: 600 !important;
            font-size: 0.875rem !important;
        }
        
        .markdown-content td {
            padding: 0.75rem !important;
            border-bottom: 1px solid #e5e7eb !important;
            font-size: 0.875rem !important;
            line-height: 1.5 !important;
            color: #4b5563 !important; /* Medium grey for table text */
        }
        
        .markdown-content tr:nth-child(even) {
            background-color: #f9fafb !important;
        }
        
        .markdown-content tr:hover {
            background-color: #f3f4f6 !important;
        }
        
        /* Enhanced heading styling for legal sections */
        .markdown-content h2 {
            position: relative !important;
            padding-left: 1rem !important;
        }
        
        .markdown-content h2::before {
            content: "⚖️" !important;
            position: absolute !important;
            left: -0.5rem !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            font-size: 1.25rem !important;
        }
        
        .markdown-content h3 {
            position: relative !important;
            padding-left: 1rem !important;
        }
        
        .markdown-content h3::before {
            content: "📋" !important;
            position: absolute !important;
            left: -0.5rem !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            font-size: 1rem !important;
        }
        
        .markdown-content h4 {
            position: relative !important;
            padding-left: 1rem !important;
        }
        
        .markdown-content h4::before {
            content: "📄" !important;
            position: absolute !important;
            left: -0.5rem !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            font-size: 0.875rem !important;
        }
        
        /* Enhanced dark mode support for legal documents */
        [data-theme="dark"] {
            /* Override base markdown content color for dark mode */
            .markdown-content {
                color: #ffffff !important; /* Pure white text for dark mode */
            }
            
            .markdown-content h1 {
                color: #ffffff !important; /* Pure white for titles */
                border-bottom-color: #4b5563 !important;
            }
            
            .markdown-content h2 {
                color: #ffffff !important; /* Pure white for titles */
            }
            
            .markdown-content h3 {
                color: #ffffff !important; /* Pure white for titles */
            }
            
            .markdown-content h4, .markdown-content h5, .markdown-content h6 {
                color: #ffffff !important; /* Pure white for titles */
            }
            
            .markdown-content p {
                color: #ffffff !important; /* Pure white for text */
            }
            
            .markdown-content strong {
                color: #ffffff !important; /* Pure white for strong text */
                font-weight: 700 !important;
            }
            
            .markdown-content b {
                color: #ffffff !important; /* Pure white for bold text */
                font-weight: 700 !important;
            }
            
            .markdown-content em {
                color: #ffffff !important; /* Pure white for italic text */
            }
            
            .markdown-content ul li, .markdown-content ol li {
                color: #ffffff !important; /* Pure white for list items */
            }
            
            .markdown-content blockquote {
                background-color: #374151 !important; /* Dark grey background */
                border-left-color: #60a5fa !important; /* Blue border */
                color: #ffffff !important; /* Pure white text */
            }
            
            .markdown-content blockquote::before {
                background: #60a5fa !important; /* Light blue background for icon */
                color: #1f2937 !important; /* Dark text on light background */
            }
            
            .markdown-content a {
                color: #60a5fa !important; /* Light blue for links */
            }
            
            .markdown-content a:hover {
                color: #93c5fd !important; /* Lighter blue on hover */
            }
            
            /* Dark mode for legal elements */
            .legal-article {
                background-color: #4b5563 !important; /* Lighter dark background for dark mode */
                color: #ffffff !important; /* Pure white text */
                border: none !important; /* No border */
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important; /* Subtle shadow */
                white-space: nowrap !important; /* Prevent line breaks within article boxes */
                display: inline-block !important; /* Keep as inline element */
            }
            
            .legal-case {
                color: #ffffff !important; /* Pure white for case names */
            }
            
            .legal-page {
                color: #ffffff !important; /* Pure white for page references */
            }
            
            .legal-list-item {
                color: #ffffff !important; /* Pure white for list items */
                border-left-color: #9ca3af !important; /* Lighter grey border for dark mode */
                background: none !important; /* No background */
            }
            
            /* Removed duplicate bold text styling - consolidated above */
            
            /* Dark mode for code elements */
            .markdown-content code {
                background-color: #4b5563 !important; /* Lighter dark background for code */
                color: #ffffff !important; /* Pure white text */
                border: none !important; /* No border */
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important; /* Subtle shadow */
            }
            
            /* Dark mode for pre blocks */
            .markdown-content pre {
                background-color: #1f2937 !important;
                color: #ffffff !important; /* Pure white text */
                border: 1px solid #374151 !important;
            }
            
            /* Dark mode for all titles - comprehensive coverage */
            .markdown-content h1, .markdown-content h2, .markdown-content h3, 
            .markdown-content h4, .markdown-content h5, .markdown-content h6 {
                color: #ffffff !important; /* Pure white for all titles */
            }
            
            .markdown-content h1 {
                border-bottom-color: #4b5563 !important;
            }
            
            /* Dark mode for bold text - comprehensive coverage */
            .markdown-content strong, 
            .markdown-content b, 
            .markdown-content .bold,
            .markdown-content *[style*="font-weight: bold"],
            .markdown-content *[style*="font-weight:bold"],
            .markdown-content strong *,
            .markdown-content b * {
                color: #ffffff !important; /* Pure white for all bold text */
                font-weight: 700 !important;
            }
            
            .markdown-content ol li {
                background-color: #374151 !important; /* Dark grey background */
                border-left-color: #60a5fa !important; /* Light blue border */
                color: #ffffff !important; /* Pure white text */
            }
            
            .markdown-content ol li::before {
                background-color: #60a5fa !important; /* Light blue for numbers */
                color: #1f2937 !important; /* Dark text on light background */
            }
            
            .markdown-content ol li p {
                color: #9ca3af !important; /* Light grey for page references */
            }
            
            
            
            /* Dark mode table styling */
            .markdown-content table {
                background-color: #374151 !important;
                color: #e5e7eb !important;
            }
            
            .markdown-content th {
                background-color: #1f2937 !important;
                color: #f9fafb !important;
            }
            
            .markdown-content td {
                border-bottom-color: #4b5563 !important;
                color: #e5e7eb !important;
            }
            
            .markdown-content tr:nth-child(even) {
                background-color: #4b5563 !important;
            }
            
            .markdown-content tr:hover {
                background-color: #6b7280 !important;
            }
            
            /* Harmonized dark mode - white tones */
            .markdown-content h1 {
                color: #ffffff !important; /* Pure white for main titles */
                border-bottom-color: #6b7280 !important; /* Lighter border */
            }
            
            .markdown-content h2 {
                color: #f9fafb !important; /* Bright white for section headers */
                border-bottom-color: #6b7280 !important; /* Lighter border */
            }
            
            .markdown-content h3 {
                color: #f3f4f6 !important; /* Very light grey for subsections */
            }
            
            .markdown-content h4 {
                color: #e5e7eb !important; /* Light grey for h4 */
            }
            
            .markdown-content h5 {
                color: #d1d5db !important; /* Medium light grey for h5 */
            }
            
            .markdown-content h6 {
                color: #d1d5db !important; /* Medium light grey for h6 */
            }
            
            /* Harmonized dark mode text elements - white tones */
            .markdown-content p {
                color: #ffffff !important; /* Pure white for paragraphs */
                line-height: 1.7 !important; /* Better line spacing for dark mode */
            }
            
            /* Enhanced dark mode for code elements */
            .markdown-content code {
                background-color: #4b5563 !important; /* Lighter dark background */
                color: #ffffff !important; /* Pure white text */
                border: none !important; /* No border */
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important; /* Enhanced shadow */
            }
            
            /* Harmonized dark mode strong/bold text - white tones */
            .markdown-content strong, .markdown-content b {
                color: #ffffff !important; /* Pure white for bold text */
                font-weight: 700 !important;
            }
            
            /* Harmonized dark mode italic text - white tones */
            .markdown-content em, .markdown-content i {
                color: #ffffff !important; /* Pure white for italic text */
                font-style: italic !important;
            }
            
            /* Enhanced dark mode for links */
            .markdown-content a {
                color: #60a5fa !important; /* Light blue for links */
                text-decoration: underline !important;
            }
            
            .markdown-content a:hover {
                color: #93c5fd !important; /* Lighter blue on hover */
                text-decoration: underline !important;
            }
            
            /* Harmonized dark mode lists - white tones */
            .markdown-content ul, .markdown-content ol {
                color: #ffffff !important; /* Pure white for lists */
            }
            
            .markdown-content ul li, .markdown-content ol li {
                color: #ffffff !important; /* Pure white for list items */
                background-color: #374151 !important; /* Dark background for list items */
                border-left-color: #9ca3af !important; /* Light grey left border */
            }
            
            .markdown-content ul li::before, .markdown-content ol li::before {
                background-color: #9ca3af !important; /* Light grey background for bullets/numbers */
                color: #1f2937 !important; /* Dark text on light background */
            }
            
            /* Enhanced dark mode for pre blocks */
            .markdown-content pre {
                background-color: #1f2937 !important; /* Dark background */
                color: #f9fafb !important; /* Bright white text */
                border: 1px solid #4b5563 !important; /* Lighter border */
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important; /* Enhanced shadow */
            }
            
            .markdown-content pre code {
                background-color: transparent !important; /* No background for code inside pre */
                color: inherit !important; /* Inherit color from pre */
                border: none !important; /* No border for code inside pre */
                box-shadow: none !important; /* No shadow for code inside pre */
            }
            
            /* Harmonized dark mode legal elements - white tones */
            .legal-article {
                background-color: #4b5563 !important; /* Lighter dark background */
                color: #ffffff !important; /* Pure white text */
                border: none !important; /* No border */
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important; /* Subtle shadow */
            }
            
            .legal-case {
                color: #ffffff !important; /* Pure white for case names */
                font-weight: 700 !important;
            }
            
            .legal-page {
                color: #ffffff !important; /* Pure white for page references */
                font-style: italic !important;
            }
            
            .legal-list-item {
                color: #ffffff !important; /* Pure white for list items */
                background-color: #374151 !important; /* Dark background */
                border-left-color: #9ca3af !important; /* Light grey left border */
            }
            
            /* Enhanced dark mode for horizontal rules */
            .markdown-content hr {
                border-color: #4b5563 !important; /* Lighter border for dark mode */
                background-color: #4b5563 !important; /* Lighter background */
            }
            
            /* Enhanced dark mode for emphasis and highlights */
            .markdown-content mark {
                background-color: #fbbf24 !important; /* Yellow highlight */
                color: #1f2937 !important; /* Dark text on yellow */
                padding: 0.125rem 0.25rem !important;
                border-radius: 0.25rem !important;
            }
        }
        
        /* Custom scrollbar for textarea - only show when needed */
        .chat-textarea::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .chat-textarea::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .chat-textarea::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Hide scrollbar when not needed */
        .chat-textarea {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        
        /* Hide scrollbar when no text or text fits */
        .chat-textarea:not(.has-scroll)::-webkit-scrollbar {
            display: none;
        }
        
        .chat-textarea:not(.has-scroll) {
            scrollbar-width: none;
        }
        
        /* Mobile keyboard optimizations */
        @media (max-width: 768px) {
            .keyboard-open {
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
            }
            
            .keyboard-open .chat-container {
                height: calc(100vh - 60px);
                height: calc(100dvh - 60px);
            }
            
            .keyboard-open .messages-container {
                height: calc(100vh - 120px);
                height: calc(100dvh - 120px);
            }
            
            /* Prevent zoom on input focus */
            input[type="text"],
            input[type="email"],
            input[type="password"],
            textarea {
                font-size: 16px;
            }
            
            /* Mobile text input improvements */
            .mobile-input {
                -webkit-appearance: none;
                appearance: none;
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: text;
                user-select: text;
                -webkit-text-size-adjust: 100%;
                text-size-adjust: 100%;
            }
            
            /* Prevent input jumping on mobile */
            .mobile-input:focus {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
            }
            
            /* Better touch targets */
            button, .clickable {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Send button positioning and interaction fixes */
            .mobile-send-button {
                z-index: 10;
                pointer-events: auto;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Ensure textarea doesn't interfere with button */
            .chat-textarea {
                padding-right: 3rem; /* Make space for the button */
                transition: height 0.2s ease-out, margin-top 0.2s ease-out;
            }
            
            /* Prevent text selection on button */
            .mobile-send-button:active {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            
            /* Smooth keyboard transitions */
            .chat-input-container {
                transition: all 0.3s ease;
                background-color: var(--bg-primary);
                padding: 1rem 0;
            }
            
            /* Mobile-specific input styling */
            .mobile-input {
                -webkit-appearance: none;
                appearance: none;
                border-radius: 8px;
                font-size: 16px;
                line-height: 1.4;
            }
            
            /* Prevent text selection on UI elements */
            .no-select {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }
        
        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            .ios-keyboard-fix {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
            }
        }
        
        /* Mobile menu fixes */
        @media (max-width: 1023px) {
            .mobile-menu-hidden {
                transform: translateX(-100%);
            }
            .mobile-menu-visible {
                transform: translateX(0);
            }
        }
        
        @media (min-width: 1024px) {
            .mobile-menu-hidden,
            .mobile-menu-visible {
                transform: translateX(0);
            }
        }
        
        /* Copy button styling */
        .copy-button {
            transition: all 0.2s ease-in-out;
            background-color: #f3f4f6;
            border: none;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
        }
        
        .copy-button:hover {
            background-color: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .copy-button.copied {
            background-color: #f3f4f6;
            color: #10b981;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .copy-button.copied:hover {
            background-color: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Dark mode copy button */
        [data-theme="dark"] .copy-button {
            background-color: #374151;
            color: #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="dark"] .copy-button:hover {
            background-color: #4b5563;
            color: #f9fafb;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        
        [data-theme="dark"] .copy-button.copied {
            background-color: #374151;
            color: #10b981;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="dark"] .copy-button.copied:hover {
            background-color: #4b5563;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        /* Dark mode styles */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --sidebar-bg: #1f2937;
            --sidebar-text: #ffffff;
            --sidebar-hover: #374151;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --input-text: #111827;
            --message-user-bg: #dbeafe;
            --logo-bg: transparent;
        }
        
        [data-theme="dark"] {
            --bg-primary: #374151;
            --bg-secondary: #4b5563;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #6b7280;
            --sidebar-bg: #1f2937;
            --sidebar-text: #f1f5f9;
            --sidebar-hover: #374151;
            --input-bg: #4b5563;
            --input-border: #6b7280;
            --input-text: #f3f4f6;
            --message-user-bg: #1f2937;
            --logo-bg: #ffffff;
        }
        
        /* Apply theme variables */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .bg-gray-50 {
            background-color: var(--bg-primary) !important;
        }
        
        .bg-white {
            background-color: var(--bg-secondary) !important;
        }
        
        .text-gray-800 {
            color: var(--text-primary) !important;
        }
        
        .text-gray-600 {
            color: var(--text-secondary) !important;
        }
        
        .border-gray-300 {
            border-color: var(--border-color) !important;
        }
        
        .bg-gray-900 {
            background-color: var(--sidebar-bg) !important;
        }
        
        .text-white {
            color: var(--sidebar-text) !important;
        }
        
        .hover\\:bg-gray-800:hover {
            background-color: var(--sidebar-hover) !important;
        }
        
        .bg-blue-50 {
            background-color: var(--message-user-bg) !important;
        }
        
        
        /* Input styling with rounded borders */
        .chat-textarea {
            background-color: var(--input-bg) !important;
            border: none !important;
            color: var(--input-text) !important;
            border-radius: 20px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Placeholder text centering */
        .chat-textarea::placeholder {
            line-height: 1.4;
            position: relative;
            top: 0.125rem;
        }
        
        .chat-textarea:focus {
            border: none !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important;
        }
        
        /* Dark mode shadow enhancement */
        [data-theme="dark"] .chat-textarea {
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* User message styling with rounded borders */
        .user-message {
            background-color: var(--message-user-bg) !important;
            border-radius: 20px !important;
            color: var(--text-primary) !important;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        
        
        /* Logo styling for dark mode */
        .logo-container {
            background-color: var(--logo-bg);
            border-radius: 8px;
            padding: 4px;
        }
        
        /* Dark mode specific logo styling */
        [data-theme="dark"] .logo-container {
            background-color: var(--logo-bg);
            border-radius: 8px;
            padding: 4px;
        }
        
        /* Mobile header fixes */
        @media (max-width: 768px) {
            .mobile-header {
                position: sticky;
                top: 0;
                z-index: 50;
                background-color: var(--bg-primary);
                width: 100%;
                flex-shrink: 0;
            }
            
            /* Ensure header stays above other content */
            .mobile-header * {
                position: relative;
                z-index: 51;
            }
            
            /* Ensure the main chat area header container is properly positioned */
            .main-chat-area {
                position: relative;
                z-index: 1;
            }
            
            /* Ensure conversation menu appears above everything */
            .conversation-menu-container {
                position: relative;
                z-index: 99999;
            }
            
            /* Make sure header doesn't get hidden by scrolling */
            .main-chat-area .mobile-header {
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            /* Fix messages container spacing for mobile header */
            .messages-container {
                padding-top: 1.5rem !important;
                padding-bottom: 1rem !important;
                transition: height 0.2s ease-out;
            }
            
            /* Add extra top padding to first message on mobile */
            .messages-container > div:first-child {
                padding-top: 1rem;
            }
            
            /* Ensure proper spacing for mobile header */
            .mobile-messages-wrapper {
                padding-top: 0.75rem;
            }
            
            /* Additional spacing for first message on mobile */
            .mobile-messages-wrapper .max-w-xs:first-child,
            .mobile-messages-wrapper .max-w-sm:first-child,
            .mobile-messages-wrapper .max-w-md:first-child,
            .mobile-messages-wrapper .max-w-lg:first-child,
            .mobile-messages-wrapper .max-w-xl:first-child,
            .mobile-messages-wrapper .max-w-2xl:first-child,
            .mobile-messages-wrapper .max-w-3xl:first-child {
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ChatMessage = ({ message, isUser, isLoading = false, style }) => {
            const [copySuccess, setCopySuccess] = useState(false);
            
            const copyToClipboard = async (text) => {
                try {
                    await navigator.clipboard.writeText(text);
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        setCopySuccess(true);
                        setTimeout(() => setCopySuccess(false), 2000);
                    } catch (fallbackErr) {
                        console.error('Fallback copy failed: ', fallbackErr);
                    }
                    document.body.removeChild(textArea);
                }
            };
            
            const renderMarkdown = (text) => {
                if (isUser) {
                    return (
                        <div className="flex justify-end mb-6 sm:mb-8">
                            <div className="max-w-xs sm:max-w-md md:max-w-lg lg:max-w-2xl">
                                <div className="user-message p-3 sm:p-4 inline-block max-w-fit">
                                    <p className="text-sm sm:text-base lg:text-lg leading-relaxed break-words">{text}</p>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // Extract disclaimer from text if it exists
                const disclaimerRegex = /---\s*\n\*This analysis is based on retrieved legal documents and should be verified against primary sources\.\*/;
                const hasDisclaimer = disclaimerRegex.test(text);
                const textWithoutDisclaimer = text.replace(disclaimerRegex, '').trim();
                
                try {
                    // Configure marked for legal document formatting
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        sanitize: false,
                        smartLists: true,
                        smartypants: true
                    });
                    
                    // Custom renderer for better legal formatting
                    const renderer = new marked.Renderer();
                    
                    // Custom code renderer for Articles
                    renderer.codespan = function(code) {
                        return `<code class="legal-article">${code}</code>`;
                    };
                    
                    // Custom strong renderer for case names
                    renderer.strong = function(text) {
                        return `<strong class="legal-case">${text}</strong>`;
                    };
                    
                    // Custom em renderer for page references
                    renderer.em = function(text) {
                        return `<em class="legal-page">${text}</em>`;
                    };
                    
                    // Custom list renderer for better spacing
                    renderer.listitem = function(text) {
                        return `<li class="legal-list-item">${text}</li>`;
                    };
                    
                    marked.use({ renderer });
                    
                    const html = marked.parse(textWithoutDisclaimer);
                    return (
                        <div className="flex justify-start mb-6 sm:mb-8">
                            <div className="max-w-xs sm:max-w-2xl lg:max-w-3xl w-full">
                                <div 
                                    className="markdown-content text-sm leading-tight"
                                    style={style ? { color: style.split(':')[1]?.trim() } : undefined}
                                    dangerouslySetInnerHTML={{ __html: html }}
                                />
                                {hasDisclaimer && (
                                    <div className="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                                        <p className="text-xs text-gray-500 dark:text-gray-400 italic text-center">
                                            This analysis is based on retrieved legal documents and should be verified against primary sources.
                                        </p>
                                    </div>
                                )}
                                <div className="flex justify-end mt-3">
                                    <button
                                        onClick={() => copyToClipboard(text)}
                                        className={`px-3 py-2 rounded-lg transition-all duration-200 copy-button`}
                                        title={copySuccess ? "Copied!" : "Copy answer to clipboard"}
                                    >
                                        <i className={`fas ${copySuccess ? 'fa-check' : 'fa-copy'} text-sm`}></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                } catch (error) {
                    console.error('Markdown parsing error:', error);
                    return (
                        <div className="flex justify-start mb-6 sm:mb-8">
                            <div className="max-w-xs sm:max-w-2xl lg:max-w-3xl w-full">
                                <p className="text-sm leading-tight break-words">{textWithoutDisclaimer}</p>
                                {hasDisclaimer && (
                                    <div className="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                                        <p className="text-xs text-gray-500 dark:text-gray-400 italic text-center">
                                            This analysis is based on retrieved legal documents and should be verified against primary sources.
                                        </p>
                                    </div>
                                )}
                                <div className="flex justify-end mt-3">
                                    <button
                                        onClick={() => copyToClipboard(text)}
                                        className={`px-3 py-2 rounded-lg transition-all duration-200 copy-button`}
                                        title={copySuccess ? "Copied!" : "Copy answer to clipboard"}
                                    >
                                        <i className={`fas ${copySuccess ? 'fa-check' : 'fa-copy'} text-sm`}></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }
            };

            return (
                <div className="w-full">
                    {isLoading ? (
                        <div className="flex justify-center mb-6 sm:mb-8">
                            <div className="max-w-xs sm:max-w-2xl lg:max-w-3xl w-full px-3 sm:px-4 lg:px-6">
                                <div className="flex items-center space-x-1 text-sm sm:text-base lg:text-lg text-gray-600">
                                    <span>AI is working on your request</span>
                                    <div className="typing-dots"></div>
                                </div>
                            </div>
                        </div>
                    ) : (
                        renderMarkdown(message)
                    )}
                </div>
            );
        };

        const ChatInput = ({ onSendMessage, isLoading, isCentered = false, hasUserInteracted = false }) => {
            const [message, setMessage] = useState('');
            const [hasScroll, setHasScroll] = useState(false);
            const [isKeyboardOpen, setIsKeyboardOpen] = useState(false);
            const [isMobile, setIsMobile] = useState(false);
            const textareaRef = useRef(null);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (message.trim() && !isLoading) {
                    onSendMessage(message.trim());
                    setMessage('');
                }
            };

            const handleKeyDown = (e) => {
                // Allow standard keyboard shortcuts (Ctrl+A, Ctrl+C, Ctrl+V, etc.)
                if (e.ctrlKey || e.metaKey) {
                    return; // Let the browser handle standard shortcuts
                }
                
                // Allow special keys like Delete, Backspace, Arrow keys, etc.
                const specialKeys = [
                    'Delete', 'Backspace', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
                    'Home', 'End', 'PageUp', 'PageDown', 'Tab', 'Escape', 'F1', 'F2', 'F3',
                    'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12'
                ];
                
                if (specialKeys.includes(e.key)) {
                    return; // Let the browser handle special keys
                }
                
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSubmit(e);
                }
            };


            const handlePaste = (e) => {
                console.log('Paste event triggered');
                console.log('Current message state before paste:', message);
                console.log('Textarea value before paste:', textareaRef.current?.value);
                
                // Get the pasted text from clipboard
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                console.log('Pasted text:', pastedText);
                
                if (pastedText) {
                    // Manually update the message state with the pasted text
                    const newMessage = message + pastedText;
                    console.log('New message after paste:', newMessage);
                    setMessage(newMessage);
                    
                    // Trigger scroll check
                    setTimeout(() => {
                        checkScroll();
                    }, 10);
                }
            };

            // Input handler with safe height adjustment
            const handleInputChange = (e) => {
                const newValue = e.target.value;
                setMessage(newValue);
                
                // Adjust height after state update
                setTimeout(() => {
                    adjustTextareaHeight(e.target);
                }, 0);
            };

            // Safe height adjustment function
            const adjustTextareaHeight = (textarea) => {
                if (!textarea) return;
                
                // Store cursor position
                const cursorPosition = textarea.selectionStart;
                
                // Reset height to auto to get natural height
                textarea.style.height = 'auto';
                
                // Calculate new height based on scroll height
                const scrollHeight = textarea.scrollHeight;
                const minHeight = 64; // 2 rows
                const maxHeight = 200; // Maximum height before scrolling
                const newHeight = Math.min(Math.max(scrollHeight, minHeight), maxHeight);
                
                // For chat interface (not centered), expand upward by adjusting margin-top
                if (!isCentered) {
                    const heightDifference = newHeight - minHeight;
                    if (heightDifference > 0) {
                        // Move the textarea up by adjusting its margin-top
                        textarea.style.marginTop = `-${heightDifference}px`;
                        
                        // Shrink the messages container to compensate
                        const messagesContainer = document.querySelector('.messages-container');
                        if (messagesContainer) {
                            const currentHeight = messagesContainer.style.height || 'calc(100vh - 200px)';
                            const baseHeight = 'calc(100vh - 200px)';
                            const adjustedHeight = `calc(100vh - 200px - ${heightDifference}px)`;
                            messagesContainer.style.height = adjustedHeight;
                        }
                    } else {
                        // Reset margin when height is at minimum
                        textarea.style.marginTop = '0px';
                        
                        // Reset messages container height
                        const messagesContainer = document.querySelector('.messages-container');
                        if (messagesContainer) {
                            messagesContainer.style.height = 'calc(100vh - 200px)';
                        }
                    }
                }
                
                // Set the new height
                textarea.style.height = newHeight + 'px';
                
                // Restore cursor position
                if (cursorPosition !== null) {
                    textarea.setSelectionRange(cursorPosition, cursorPosition);
                }
            };

            const checkScroll = () => {
                if (textareaRef.current) {
                    const hasScrollbar = textareaRef.current.scrollHeight > textareaRef.current.clientHeight;
                    setHasScroll(hasScrollbar);
                }
            };

            // Remove the problematic useEffect that was causing character skipping

            // Additional effect to ensure proper sizing on mount/refresh
            useEffect(() => {
                if (textareaRef.current) {
                    // Small delay to ensure DOM is fully rendered
                    const timer = setTimeout(() => {
                        if (textareaRef.current) {
                            textareaRef.current.style.height = 'auto';
                            const scrollHeight = textareaRef.current.scrollHeight;
                            textareaRef.current.style.height = scrollHeight + 'px';
                        }
                    }, 100);
                    return () => clearTimeout(timer);
                }
            }, [isCentered]);

            // Auto-focus the textarea when component mounts (but not on mobile unless it's a new conversation)
            useEffect(() => {
                if (textareaRef.current) {
                    // Only auto-focus on desktop or if it's a new conversation (centered input) or user hasn't interacted
                    const shouldAutoFocus = !isMobile || isCentered || !hasUserInteracted;
                    
                    if (shouldAutoFocus) {
                        // Small delay to ensure the component is fully rendered
                        setTimeout(() => {
                            textareaRef.current.focus();
                        }, 100);
                    }
                }
            }, [isMobile, isCentered, hasUserInteracted]);

            // Mobile detection
            useEffect(() => {
                const checkMobile = () => {
                    setIsMobile(window.innerWidth <= 768);
                };
                
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);

            // Keyboard detection for mobile
            useEffect(() => {
                if (!isMobile) return;

                const initialViewportHeight = window.innerHeight;
                let timeoutId;

                const handleResize = () => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        const currentHeight = window.innerHeight;
                        const heightDifference = initialViewportHeight - currentHeight;
                        
                        // If height decreased by more than 150px, keyboard is likely open
                        setIsKeyboardOpen(heightDifference > 150);
                    }, 100);
                };

                window.addEventListener('resize', handleResize);
                return () => {
                    window.removeEventListener('resize', handleResize);
                    clearTimeout(timeoutId);
                };
            }, [isMobile]);

            // Focus/blur handlers for keyboard detection
            const handleFocus = () => {
                if (isMobile) {
                    setIsKeyboardOpen(true);
                    // Scroll to input after a short delay to ensure keyboard is open
                    setTimeout(() => {
                        textareaRef.current?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            };

            const handleBlur = () => {
                if (isMobile) {
                    // Delay to allow for keyboard close animation
                    setTimeout(() => {
                        setIsKeyboardOpen(false);
                    }, 300);
                }
            };

            const handleClick = () => {
                // On mobile, allow manual focus when user taps the input
                if (isMobile && textareaRef.current) {
                    textareaRef.current.focus();
                }
            };

            useEffect(() => {
                const textarea = textareaRef.current;
                if (textarea) {
                    textarea.addEventListener('input', checkScroll);
                    textarea.addEventListener('resize', checkScroll);
                    textarea.addEventListener('focus', handleFocus);
                    textarea.addEventListener('blur', handleBlur);
                    return () => {
                        textarea.removeEventListener('input', checkScroll);
                        textarea.removeEventListener('resize', checkScroll);
                        textarea.removeEventListener('focus', handleFocus);
                        textarea.removeEventListener('blur', handleBlur);
                    };
                }
            }, [isMobile]);

            if (isCentered) {
                return (
                    <div className="flex-1 flex items-start justify-center p-4 sm:p-6 lg:p-8 pt-24 sm:pt-32 lg:pt-40">
                        <div className="w-full max-w-xs sm:max-w-2xl lg:max-w-3xl">
                            <div className="text-center mb-6 sm:mb-8">
                                <div className="w-16 h-16 sm:w-20 sm:h-20 flex items-center justify-center mx-auto mb-3 sm:mb-4 logo-container">
                                    <img 
                                        src="/static/icc_logo.svg" 
                                        alt="ICC Logo" 
                                        className="w-full h-full object-contain"
                                        onError={(e) => {
                                            e.target.style.display = 'none';
                                            e.target.nextSibling.style.display = 'flex';
                                        }}
                                    />
                                    <div className="w-full h-full bg-blue-500 rounded-full flex items-center justify-center" style={{display: 'none'}}>
                                        <i className="fas fa-robot text-white text-lg sm:text-2xl"></i>
                                    </div>
                                </div>
                                <h1 className="text-lg sm:text-xl lg:text-2xl font-semibold text-gray-800 mb-2">ICC Legal Research Assistant</h1>
                                <p className="text-sm sm:text-base text-gray-600">Search past judgments and explore international humanitarian law texts</p>
                            </div>
                            <form onSubmit={handleSubmit} className="relative">
                                <div className="relative">
                                    <textarea
                                        ref={textareaRef}
                                        value={message}
                                        onChange={handleInputChange}
                                        onKeyDown={handleKeyDown}
                                        onPaste={handlePaste}
                                        onFocus={handleFocus}
                                        onBlur={handleBlur}
                                        onClick={handleClick}
                                        placeholder={isMobile ? "Ask about legal provisions..." : "Search past judgments or ask about IHL provisions..."}
                                        className={`w-full px-3 sm:px-4 py-2 sm:py-3 pr-12 sm:pr-14 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base overflow-y-auto chat-textarea mobile-input ${isKeyboardOpen ? 'keyboard-open' : ''}`}
                                        rows="2"
                                        disabled={isLoading}
                                        style={{ 
                                            minHeight: '64px',
                                            maxHeight: '200px',
                                            scrollbarWidth: 'thin',
                                            fontSize: isMobile ? '16px' : undefined
                                        }}
                                    />
                                    {message.trim() && (
                                        <button
                                            type="submit"
                                            disabled={isLoading}
                                            className="absolute right-2 sm:right-3 top-1/2 transform -translate-y-1/2 w-6 h-6 sm:w-8 sm:h-8 md:w-9 md:h-9 bg-gray-700 hover:bg-gray-800 text-white rounded-full flex items-center justify-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed mobile-send-button"
                                            style={{
                                                zIndex: 10,
                                                pointerEvents: 'auto',
                                                touchAction: 'manipulation'
                                            }}
                                            onMouseDown={(e) => {
                                                e.preventDefault();
                                                e.stopPropagation();
                                            }}
                                            onTouchStart={(e) => {
                                                e.preventDefault();
                                                e.stopPropagation();
                                            }}
                                        >
                                            <i className="fas fa-arrow-up text-xs sm:text-sm"></i>
                                        </button>
                                    )}
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex justify-center p-3 sm:p-4 lg:p-6">
                    <div className="w-full max-w-xs sm:max-w-2xl lg:max-w-3xl">
                        <form onSubmit={handleSubmit} className="relative">
                            <div className="relative">
                                <textarea
                                    ref={textareaRef}
                                    value={message}
                                    onChange={handleInputChange}
                                    onKeyDown={handleKeyDown}
                                    onPaste={handlePaste}
                                    onFocus={handleFocus}
                                    onBlur={handleBlur}
                                    onClick={handleClick}
                                    placeholder={isMobile ? "Ask about legal provisions..." : "Search past judgments or ask about IHL provisions..."}
                                    className={`w-full px-3 sm:px-4 py-2 sm:py-3 pr-12 sm:pr-14 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base overflow-y-auto chat-textarea mobile-input ${isKeyboardOpen ? 'keyboard-open' : ''}`}
                                    rows="2"
                                    disabled={isLoading}
                                    style={{ 
                                        minHeight: '64px',
                                        maxHeight: '200px',
                                        scrollbarWidth: 'thin',
                                        fontSize: isMobile ? '16px' : undefined
                                    }}
                                />
                                {message.trim() && (
                                    <button
                                        type="submit"
                                        disabled={isLoading}
                                        className="absolute right-2 sm:right-3 top-1/2 transform -translate-y-1/2 w-6 h-6 sm:w-8 sm:h-8 md:w-9 md:h-9 bg-gray-700 hover:bg-gray-800 text-white rounded-full flex items-center justify-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed mobile-send-button"
                                        style={{
                                            zIndex: 10,
                                            pointerEvents: 'auto',
                                            touchAction: 'manipulation'
                                        }}
                                        onMouseDown={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                        }}
                                        onTouchStart={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                        }}
                                    >
                                        <i className="fas fa-arrow-up text-xs sm:text-sm"></i>
                                    </button>
                                )}
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ conversations, currentConversationId, onSelectConversation, onNewConversation, isMobileMenuOpen, setIsMobileMenuOpen, user, onLogout, formatTimestamp, isDarkMode, toggleDarkMode, setRenameConversationId, setRenameValue, setShowRenameModal, deleteConversation }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            const [showUserMenu, setShowUserMenu] = useState(false);
            const [editingConversationId, setEditingConversationId] = useState(null);
            const [editingTitle, setEditingTitle] = useState('');
            
            // Swipe functionality for mobile
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);
            
            const minSwipeDistance = 50;
            
            const onTouchStart = (e) => {
                setTouchEnd(null);
                setTouchStart(e.targetTouches[0].clientX);
            };
            
            const onTouchMove = (e) => {
                setTouchEnd(e.targetTouches[0].clientX);
            };
            
            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                
                const distance = touchStart - touchEnd;
                const isLeftSwipe = distance > minSwipeDistance;
                
                if (isLeftSwipe && isMobileMenuOpen) {
                    setIsMobileMenuOpen(false);
                }
            };


            // Handle start rename
            const handleStartRename = (conversationId, currentTitle) => {
                setEditingConversationId(conversationId);
                setEditingTitle(currentTitle);
            };

            const handleSaveRename = async () => {
                if (editingConversationId && editingTitle.trim()) {
                    await renameConversation(editingConversationId, editingTitle.trim());
                    setEditingConversationId(null);
                    setEditingTitle('');
                }
            };

            const handleCancelRename = () => {
                setEditingConversationId(null);
                setEditingTitle('');
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleSaveRename();
                } else if (e.key === 'Escape') {
                    handleCancelRename();
                }
            };

            return (
                <>
                    {/* Mobile Overlay */}
                    {isMobileMenuOpen && (
                        <div 
                            className="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-40"
                            onClick={() => {
                                console.log('Mobile overlay clicked, closing menu');
                                setIsMobileMenuOpen(false);
                            }}
                            onTouchStart={onTouchStart}
                            onTouchMove={onTouchMove}
                            onTouchEnd={onTouchEnd}
                            style={{ zIndex: 40 }}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <div 
                        className={`bg-gray-900 text-white transition-all duration-300 flex flex-col h-screen fixed lg:relative z-[1000] ${
                            isCollapsed ? 'w-16' : 'w-64'
                        } ${
                            isMobileMenuOpen ? 'mobile-menu-visible' : 'mobile-menu-hidden'
                        }`}
                        style={{ overflow: 'visible' }}
                        onTouchStart={onTouchStart}
                        onTouchMove={onTouchMove}
                        onTouchEnd={onTouchEnd}
                    >
                        {/* Header */}
                        <div className="p-4 border-b border-gray-700">
                            <div className="flex items-center justify-between">
                                {!isCollapsed && (
                                    <button
                                        onClick={onNewConversation}
                                        className="flex items-center space-x-2 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
                                    >
                                        <i className="fas fa-plus"></i>
                                        <span className="hidden sm:inline">New chat</span>
                                    </button>
                                )}
                                <button
                                    onClick={() => setIsCollapsed(!isCollapsed)}
                                    className="p-2 hover:bg-gray-700 rounded-lg transition-colors"
                                >
                                    <i className={`fas ${isCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'}`}></i>
                                </button>
                            </div>
                        </div>

                        {/* Conversations List */}
                        <div className="flex-1 overflow-y-auto p-2 space-y-0.5" style={{ overflow: 'visible' }}>
                            {conversations.map((conversation) => (
                                <div
                                    key={conversation.id}
                                    className={`p-3 rounded-lg transition-colors ${
                                        conversation.id === currentConversationId
                                            ? 'bg-gray-700'
                                            : 'hover:bg-gray-800'
                                    }`}
                                    style={{ overflow: 'visible', height: '60px' }}
                                >
                                    {isCollapsed ? (
                                        <div className="flex justify-center">
                                            <i className="fas fa-comment text-gray-400"></i>
                                        </div>
                                    ) : (
                                        <div className="flex items-center justify-between h-full">
                                            <div 
                                                className="flex-1 min-w-0 cursor-pointer"
                                                onClick={() => {
                                                    if (editingConversationId !== conversation.id) {
                                                        onSelectConversation(conversation.id);
                                                        setIsMobileMenuOpen(false);
                                                    }
                                                }}
                                            >
                                                <div className="flex items-center justify-between">
                                                    {editingConversationId === conversation.id ? (
                                                        <input
                                                            type="text"
                                                            value={editingTitle}
                                                            onChange={(e) => setEditingTitle(e.target.value)}
                                                            onKeyPress={handleKeyPress}
                                                            onBlur={handleSaveRename}
                                                            onFocus={(e) => e.target.select()}
                                                            className="text-sm font-medium flex-1 min-w-0 bg-transparent border-none outline-none text-white"
                                                            autoFocus
                                                        />
                                                    ) : (
                                                        <p className="text-sm font-medium truncate flex-1 min-w-0">
                                                            {conversation.title || 'New Conversation'}
                                                        </p>
                                                    )}
                                                    <span className="text-xs text-gray-500 ml-2 flex-shrink-0">
                                                        {formatTimestamp(conversation.updated_at)}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        {/* Footer */}
                        <div className="p-4 border-t border-gray-700 relative">
                            {!isCollapsed && (
                                <div className="flex items-center space-x-3">
                                    <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                        <i className="fas fa-user text-white text-sm"></i>
                                    </div>
                                    <div className="hidden sm:block flex-1 min-w-0">
                                        <p className="text-sm font-medium text-white truncate">
                                            {user?.display_name || user?.email || 'User'}
                                        </p>
                                        <p className="text-xs text-gray-400 truncate">
                                            {user?.email || 'ICC Legal Research'}
                                        </p>
                                    </div>
                                    <div className="relative">
                                        <button
                                            onClick={() => setShowUserMenu(!showUserMenu)}
                                            className="text-gray-400 hover:text-white transition-colors hover:bg-gray-700 flex items-center justify-center"
                                            title="User Menu"
                                            style={{
                                                width: '32px',
                                                height: '32px',
                                                borderRadius: '50%',
                                                padding: '0',
                                                border: 'none',
                                                outline: 'none',
                                                background: 'transparent'
                                            }}
                                        >
                                            <i className="fas fa-ellipsis-v text-xs"></i>
                                        </button>
                                        
                                        {/* User Dropdown Menu */}
                                        {showUserMenu && (
                                            <div className="absolute bottom-full right-0 mb-2 w-48 bg-gray-800 shadow-lg border border-gray-700 z-50" style={{ borderRadius: '16px' }}>
                                                <div className="p-3 border-b border-gray-700">
                                                    <p className="text-sm font-medium text-white truncate">
                                                        {user?.display_name || 'User'}
                                                    </p>
                                                    <p className="text-xs text-gray-400 truncate">
                                                        {user?.email}
                                                    </p>
                                                </div>
                                                <div className="py-1">
                                                    <button
                                                        onClick={() => {
                                                            setShowUserMenu(false);
                                                            toggleDarkMode();
                                                        }}
                                                        className="w-full text-left px-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-colors rounded-lg mx-1"
                                                    >
                                                        <i className={`fas ${isDarkMode ? 'fa-sun' : 'fa-moon'} mr-2`}></i>
                                                        {isDarkMode ? 'Light Mode' : 'Dark Mode'}
                                                    </button>
                                                    <div className="border-t border-gray-700 my-1"></div>
                                                    <button
                                                        onClick={() => {
                                                            setShowUserMenu(false);
                                                            onLogout();
                                                        }}
                                                        className="w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-gray-700 hover:text-red-300 transition-colors rounded-lg mx-1"
                                                    >
                                                        <i className="fas fa-sign-out-alt mr-2"></i>
                                                        Logout
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            {isCollapsed && (
                                <div className="flex justify-center">
                                    <button
                                        onClick={onLogout}
                                        className="p-2 text-gray-400 hover:text-white transition-colors"
                                        title="Logout"
                                    >
                                        <i className="fas fa-sign-out-alt"></i>
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </>
            );
        };


        const ChatApp = () => {
            const [conversations, setConversations] = useState([]);
            const [currentConversationId, setCurrentConversationId] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [user, setUser] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [authLoading, setAuthLoading] = useState(true);
            const [conversationsLoading, setConversationsLoading] = useState(false);
            const [isKeyboardOpen, setIsKeyboardOpen] = useState(false);
            const [isMobile, setIsMobile] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [hasUserInteracted, setHasUserInteracted] = useState(false);
            const [showHeaderMenu, setShowHeaderMenu] = useState(false);
            const [showRenameModal, setShowRenameModal] = useState(false);
            const [renameValue, setRenameValue] = useState('');
            const [renameConversationId, setRenameConversationId] = useState(null);
            const messagesEndRef = useRef(null);

            const currentConversation = conversations.find(c => c.id === currentConversationId);
            const messages = currentConversation?.messages || [];
            
            // Debug logging
            console.log('Current conversation:', currentConversation);
            console.log('Messages:', messages);

            // Utility functions
            const formatTimestamp = (timestamp) => {
                if (!timestamp) {
                    return 'Unknown';
                }
                
                const date = new Date(timestamp);
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    console.error('Invalid timestamp:', timestamp);
                    return 'Unknown';
                }
                
                const now = new Date();
                const diffInHours = (now - date) / (1000 * 60 * 60);
                
                if (diffInHours < 24) {
                    // Show time if within 24 hours
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else if (diffInHours < 24 * 7) {
                    // Show day of week if within a week
                    return date.toLocaleDateString([], { weekday: 'short' });
                } else {
                    // Show date if older than a week
                    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
                }
            };

            // Authentication functions using session manager
            const checkAuth = async () => {
                if (window.sessionManager) {
                    // Check if user is authenticated using session manager
                    if (window.sessionManager.isUserAuthenticated()) {
                        const user = window.sessionManager.getCurrentUser();
                        setUser(user);
                        setIsAuthenticated(true);
                    } else {
                        // Try to restore session
                        try {
                            await window.sessionManager.refreshAccessToken();
                            const user = window.sessionManager.getCurrentUser();
                            if (user) {
                                setUser(user);
                                setIsAuthenticated(true);
                            }
                        } catch (error) {
                            console.error('Session restoration failed:', error);
                        }
                    }
                } else {
                    // Fallback to old method if session manager not available
                    const token = localStorage.getItem('access_token');
                    const userData = localStorage.getItem('user');
                    
                    if (token && userData) {
                        try {
                            const response = await fetch('/auth/me', {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (response.ok) {
                                const user = await response.json();
                                setUser(user);
                                setIsAuthenticated(true);
                            } else {
                                // Token invalid, try refresh
                                await refreshToken();
                            }
                        } catch (error) {
                            console.error('Auth check failed:', error);
                            await refreshToken();
                        }
                    }
                }
                setAuthLoading(false);
            };

            const refreshToken = async () => {
                const refreshToken = localStorage.getItem('refresh_token');
                if (!refreshToken) {
                    setAuthLoading(false);
                    return;
                }

                try {
                    const response = await fetch('/auth/refresh', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ refresh_token: refreshToken }),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        localStorage.setItem('access_token', data.access_token);
                        localStorage.setItem('refresh_token', data.refresh_token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        setUser(data.user);
                        setIsAuthenticated(true);
                    } else {
                        // Refresh failed, redirect to login
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('refresh_token');
                        localStorage.removeItem('user');
                        setUser(null);
                        setIsAuthenticated(false);
                    }
                } catch (error) {
                    console.error('Token refresh failed:', error);
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user');
                    setUser(null);
                    setIsAuthenticated(false);
                }
            };

            const logout = () => {
                if (window.sessionManager) {
                    window.sessionManager.logout();
                } else {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user');
                }
                setUser(null);
                setIsAuthenticated(false);
                setConversations([]);
                setCurrentConversationId(null);
            };

            const toggleDarkMode = () => {
                const newTheme = isDarkMode ? 'light' : 'dark';
                setIsDarkMode(!isDarkMode);
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            };

            // Conversation management functions
            const loadConversations = async () => {
                if (!isAuthenticated) return;
                
                setConversationsLoading(true);
                try {
                    let response;
                    if (window.sessionManager) {
                        response = await window.sessionManager.authenticatedRequest('/conversations');
                    } else {
                        const token = localStorage.getItem('access_token');
                        response = await fetch('/conversations', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                    }

                    if (response.ok) {
                        const conversationsData = await response.json();
                        
                        // Check if there are any empty conversations and clean them up
                        const emptyConversations = conversationsData.filter(conv => conv.messages.length === 0);
                        if (emptyConversations.length > 0) {
                            try {
                                if (window.sessionManager) {
                                    await window.sessionManager.authenticatedRequest('/conversations/cleanup', {
                                        method: 'POST'
                                    });
                                } else {
                                    const token = localStorage.getItem('access_token');
                                    await fetch('/conversations/cleanup', {
                                        method: 'POST',
                                        headers: {
                                            'Authorization': `Bearer ${token}`
                                        }
                                    });
                                }
                            } catch (error) {
                                console.error('Error cleaning up empty conversations:', error);
                            }
                        }
                        
                        // Show all conversations (including empty ones for new conversations)
                        const formattedConversations = conversationsData.map(conv => ({
                            id: conv.id,
                            title: conv.title,
                            lastMessage: conv.messages.length > 0 ? conv.messages[conv.messages.length - 1].text : "",
                            messages: conv.messages.map(msg => ({
                                id: msg.id || Date.now() + Math.random(),
                                text: msg.text,
                                isUser: msg.isUser
                            })),
                            updated_at: conv.updated_at || conv.created_at || new Date().toISOString(),
                            created_at: conv.created_at || new Date().toISOString()
                        }));
                        
                        // Sort conversations by updated_at (latest first)
                        formattedConversations.sort((a, b) => {
                            const dateA = new Date(a.updated_at);
                            const dateB = new Date(b.updated_at);
                            
                            // Handle invalid dates by putting them at the end
                            if (isNaN(dateA.getTime()) && isNaN(dateB.getTime())) return 0;
                            if (isNaN(dateA.getTime())) return 1;
                            if (isNaN(dateB.getTime())) return -1;
                            
                            return dateB - dateA;
                        });
                        setConversations(formattedConversations);
                        
                        // Don't set any conversation as current by default - show new conversation UI
                        // A conversation will be created when the user sends their first message
                    }
                } catch (error) {
                    console.error('Error loading conversations:', error);
                    // Create a new conversation if loading fails
                    await createNewConversation();
                } finally {
                    setConversationsLoading(false);
                }
            };

            const createNewConversation = async () => {
                try {
                    let response;
                    if (window.sessionManager) {
                        response = await window.sessionManager.authenticatedRequest('/conversations', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ title: "New Conversation" })
                        });
                    } else {
                        const token = localStorage.getItem('access_token');
                        response = await fetch('/conversations', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ title: "New Conversation" })
                        });
                    }

                    if (response.ok) {
                        const newConv = await response.json();
                        const formattedConv = {
                            id: newConv.id,
                            title: newConv.title,
                            lastMessage: "",
                            messages: [],
                            updated_at: newConv.updated_at || newConv.created_at || new Date().toISOString(),
                            created_at: newConv.created_at || new Date().toISOString()
                        };
                        setConversations(prev => [formattedConv, ...prev]);
                        setCurrentConversationId(newConv.id);
                        return newConv.id; // Return the conversation ID
                    }
                } catch (error) {
                    console.error('Error creating conversation:', error);
                }
                return null;
            };

            const saveConversation = async (conversationId, messages) => {
                // Only save conversations that have messages
                if (messages.length === 0) {
                    return;
                }
                
                try {
                    if (window.sessionManager) {
                        await window.sessionManager.authenticatedRequest(`/conversations/${conversationId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ messages: messages })
                        });
                    } else {
                        const token = localStorage.getItem('access_token');
                        await fetch(`/conversations/${conversationId}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ messages: messages })
                        });
                    }
                } catch (error) {
                    console.error('Error saving conversation:', error);
                }
            };

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            // Dark mode initialization
            useEffect(() => {
                const initializeDarkMode = () => {
                    // Check localStorage first
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme) {
                        setIsDarkMode(savedTheme === 'dark');
                        document.documentElement.setAttribute('data-theme', savedTheme);
                    } else {
                        // Check system preference
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        setIsDarkMode(prefersDark);
                        document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                    }
                };
                
                initializeDarkMode();
                
                // Listen for system theme changes
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const handleChange = (e) => {
                    if (!localStorage.getItem('theme')) {
                        setIsDarkMode(e.matches);
                        document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                    }
                };
                
                mediaQuery.addEventListener('change', handleChange);
                return () => mediaQuery.removeEventListener('change', handleChange);
            }, []);

            // Mobile detection
            useEffect(() => {
                const checkMobile = () => {
                    setIsMobile(window.innerWidth <= 768);
                };
                
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);

            // Keyboard detection for mobile
            useEffect(() => {
                if (!isMobile) return;

                const initialViewportHeight = window.innerHeight;
                let timeoutId;

                const handleResize = () => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        const currentHeight = window.innerHeight;
                        const heightDifference = initialViewportHeight - currentHeight;
                        
                        // If height decreased by more than 150px, keyboard is likely open
                        setIsKeyboardOpen(heightDifference > 150);
                    }, 100);
                };

                window.addEventListener('resize', handleResize);
                return () => {
                    window.removeEventListener('resize', handleResize);
                    clearTimeout(timeoutId);
                };
            }, [isMobile]);

            useEffect(() => {
                checkAuth();
                
                // Set up session event listeners
                if (window.sessionManager) {
                    window.sessionManager.on('sessionExpired', () => {
                        setUser(null);
                        setIsAuthenticated(false);
                        setConversations([]);
                        setCurrentConversationId(null);
                        // Redirect to auth page
                        window.location.href = '/auth.html';
                    });
                    
                    window.sessionManager.on('logout', () => {
                        setUser(null);
                        setIsAuthenticated(false);
                        setConversations([]);
                        setCurrentConversationId(null);
                    });
                    
                    window.sessionManager.on('tokenRefreshed', (data) => {
                        if (data.user) {
                            setUser(data.user);
                        }
                    });
                }
            }, []);

            useEffect(() => {
                if (isAuthenticated) {
                    loadConversations();
                }
            }, [isAuthenticated]);

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // Initialize rename value when modal opens
            useEffect(() => {
                if (showRenameModal && currentConversation) {
                    setRenameValue(currentConversation.title || '');
                }
            }, [showRenameModal, currentConversation]);

            // Close header menu when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (showHeaderMenu && !event.target.closest('.header-menu-container')) {
                        setShowHeaderMenu(false);
                    }
                };

                if (showHeaderMenu) {
                    document.addEventListener('mousedown', handleClickOutside);
                    return () => document.removeEventListener('mousedown', handleClickOutside);
                }
            }, [showHeaderMenu]);

            // Auto-focus input when conversation changes (but not on mobile after first response)
            useEffect(() => {
                // Only auto-focus on desktop or if it's a new conversation or user hasn't interacted yet
                const shouldAutoFocus = !isMobile || !hasUserInteracted || (currentConversation && currentConversation.messages.length <= 1);
                
                if (shouldAutoFocus) {
                    const timer = setTimeout(() => {
                        const textarea = document.querySelector('.chat-textarea');
                        if (textarea) {
                            textarea.focus();
                        }
                    }, 200);
                    
                    return () => clearTimeout(timer);
                }
            }, [currentConversationId, isMobile, currentConversation, hasUserInteracted]);

            const sendMessage = async (messageText) => {
                console.log('Sending message:', messageText);
                
                // Check if user is authenticated before sending message
                if (!isAuthenticated) {
                    console.log('User not authenticated, redirecting to auth page');
                    window.location.href = '/auth.html';
                    return;
                }
                
                setHasUserInteracted(true); // Mark that user has interacted
                
                // Determine which conversation to use
                let conversationId = currentConversationId;
                if (!conversationId) {
                    conversationId = await createNewConversation();
                    if (!conversationId) {
                        console.error('Failed to create conversation');
                        return;
                    }
                }
                
                const userMessage = {
                    id: Date.now(),
                    text: messageText,
                    isUser: true
                };
                console.log('User message created:', userMessage);

                // Immediately show loading state and user message
                setIsLoading(true);

                // Update current conversation with user message
                setConversations(prevConversations => {
                    console.log('Previous conversations:', prevConversations);
                    const updatedConversations = prevConversations.map(conv =>
                        conv.id === conversationId
                            ? { ...conv, messages: [...conv.messages, userMessage], lastMessage: messageText }
                            : conv
                    );
                    
                    // Check if this is the first message and update title
                    const currentConv = updatedConversations.find(c => c.id === conversationId);
                    if (currentConv && currentConv.messages.length === 1) {
                        const firstWords = messageText.split(' ').slice(0, 4).join(' ');
                        const newTitle = firstWords.length > 0 ? firstWords : "New Conversation";
                        currentConv.title = newTitle;
                        
                        // Update title in Firestore asynchronously
                        (async () => {
                            try {
                                if (window.sessionManager) {
                                    await window.sessionManager.authenticatedRequest(`/conversations/${conversationId}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ title: newTitle })
                                    });
                                } else {
                                    const token = localStorage.getItem('access_token');
                                    await fetch(`/conversations/${conversationId}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Authorization': `Bearer ${token}`,
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ title: newTitle })
                                    });
                                }
                            } catch (error) {
                                console.error('Error updating conversation title:', error);
                            }
                        })();
                    }
                    
                    // Save to Firestore asynchronously
                    (async () => {
                        if (currentConv) {
                            await saveConversation(conversationId, currentConv.messages);
                        }
                    })();
                    
                    console.log('Updated conversations:', updatedConversations);
                    return updatedConversations;
                });

                try {
                    let response;
                    if (window.sessionManager) {
                        response = await window.sessionManager.authenticatedRequest('/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ message: messageText })
                        });
                    } else {
                        const token = localStorage.getItem('access_token');
                        response = await fetch('/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ message: messageText }),
                        });
                    }

                    if (!response.ok) {
                        if (response.status === 504) {
                            // Timeout error - AI is starting up
                            const timeoutMessage = {
                                id: Date.now() + 1,
                                text: "⏳ The AI is starting up. Please wait about 30 seconds and try again.",
                                isUser: false,
                                style: "color: rgb(255, 133, 131);"
                            };
                            
                            setConversations(prev => prev.map(conv => 
                                conv.id === conversationId 
                                    ? { ...conv, messages: [...conv.messages, timeoutMessage] }
                                    : conv
                            ));
                            return;
                        } else if (response.status === 401 || response.status === 403) {
                            // Token expired or not authenticated, try refresh
                            try {
                            await refreshToken();
                            // Retry with new token
                            const newToken = localStorage.getItem('access_token');
                                if (!newToken) {
                                    // No token available, redirect to auth
                                    window.location.href = '/auth.html';
                                    return;
                                }
                                
                            const retryResponse = await fetch('/chat', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${newToken}`
                                },
                                body: JSON.stringify({ message: messageText }),
                            });
                            
                            if (!retryResponse.ok) {
                                    if (retryResponse.status === 401 || retryResponse.status === 403) {
                                        // Still not authenticated, redirect to auth
                                        window.location.href = '/auth.html';
                                        return;
                                    }
                                    throw new Error(`Server error: ${retryResponse.status}`);
                            }
                            
                            const data = await retryResponse.json();
                            const assistantMessage = {
                                id: Date.now() + 1,
                                text: data.response,
                                isUser: false
                            };
                            
                            setConversations(prev => prev.map(conv => 
                                conv.id === conversationId 
                                    ? { ...conv, messages: [...conv.messages, assistantMessage] }
                                    : conv
                            ));
                            
                            // Save to Firestore
                            setConversations(prev => {
                                const currentConv = prev.find(c => c.id === conversationId);
                                if (currentConv) {
                                    saveConversation(conversationId, currentConv.messages);
                                }
                                return prev;
                            });
                            } catch (refreshError) {
                                console.error('Token refresh failed:', refreshError);
                                window.location.href = '/auth.html';
                                return;
                            }
                        } else if (response.status === 502) {
                            throw new Error('Service temporarily unavailable. Please try again.');
                        } else {
                            throw new Error(`Server error: ${response.status}`);
                        }
                    } else {
                        const data = await response.json();
                        
                        const assistantMessage = {
                            id: Date.now() + 1,
                            text: data.response,
                            isUser: false
                        };

                        // Update current conversation with assistant response
                        setConversations(prev => {
                            const updatedConversations = prev.map(conv =>
                                conv.id === conversationId
                                    ? { ...conv, messages: [...conv.messages, assistantMessage] }
                                    : conv
                            );
                            
                            // Save to Firestore
                            const currentConv = updatedConversations.find(c => c.id === conversationId);
                            if (currentConv) {
                                saveConversation(conversationId, currentConv.messages);
                            }
                            
                            return updatedConversations;
                        });
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    
                    // Check if it's an authentication error
                    if (error.message.includes('Authentication failed') || error.message.includes('401') || error.message.includes('403')) {
                        // Redirect to auth page for authentication errors
                        window.location.href = '/auth.html';
                        return;
                    }
                    
                    // Show user-friendly error message
                    const errorMessage = {
                        id: Date.now() + 1,
                        text: error.message.includes('Service temporarily unavailable') 
                            ? "🔧 Service temporarily unavailable. Please try again in a moment."
                            : error.message.includes('Server error')
                            ? `⚠️ Server error: ${error.message}. Please try again.`
                            : error.message.includes('timeout') || error.message.includes('Timeout') || error.name === 'TimeoutError'
                            ? "⏳ The AI is starting up. Please wait about 30 seconds and try again."
                            : "❌ Sorry, I encountered an error. Please try again.",
                        isUser: false,
                        style: (error.message.includes('timeout') || error.message.includes('Timeout') || error.name === 'TimeoutError') 
                            ? "color: rgb(255, 133, 131);" 
                            : undefined
                    };
                    
                    setConversations(prev => prev.map(conv => 
                        conv.id === conversationId 
                            ? { ...conv, messages: [...conv.messages, errorMessage] }
                            : conv
                    ));
                } finally {
                    setIsLoading(false);
                    // Auto-focus input after sending message (but not on mobile after first response)
                    const shouldAutoFocus = !isMobile || !hasUserInteracted || (currentConversation && currentConversation.messages.length <= 2);
                    
                    if (shouldAutoFocus) {
                        setTimeout(() => {
                            const textarea = document.querySelector('.chat-textarea');
                            if (textarea) {
                                textarea.focus();
                            }
                        }, 100);
                    }
                }
            };

            const selectConversation = (conversationId) => {
                setCurrentConversationId(conversationId);
            };

            const newConversation = async () => {
                // Check if current conversation is empty or not started
                if (currentConversationId && currentConversation && currentConversation.messages.length === 0) {
                    // Don't create a new conversation if current one is empty or not started
                    console.log('Current conversation is empty or not started, not creating new one');
                    return;
                }
                await createNewConversation();
            };

            const deleteConversation = async (conversationId) => {
                if (!conversationId) return;
                
                try {
                    let response;
                    if (window.sessionManager) {
                        response = await window.sessionManager.authenticatedRequest(`/conversations/${conversationId}`, {
                            method: 'DELETE'
                        });
                    } else {
                        const token = localStorage.getItem('access_token');
                        response = await fetch(`/conversations/${conversationId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                    }

                    if (response.ok) {
                        // Remove conversation from local state
                        setConversations(prev => prev.filter(conv => conv.id !== conversationId));
                        
                        // If this was the current conversation, clear it
                        if (currentConversationId === conversationId) {
                            setCurrentConversationId(null);
                        }
                    } else {
                        console.error('Failed to delete conversation');
                    }
                } catch (error) {
                    console.error('Error deleting conversation:', error);
                }
            };

            const renameConversation = async (conversationId, newTitle) => {
                if (!conversationId || !newTitle.trim()) return;
                
                try {
                    let response;
                    if (window.sessionManager) {
                        response = await window.sessionManager.authenticatedRequest(`/conversations/${conversationId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ title: newTitle.trim() })
                        });
                    } else {
                        const token = localStorage.getItem('access_token');
                        response = await fetch(`/conversations/${conversationId}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ title: newTitle.trim() })
                        });
                    }

                    if (response.ok) {
                        // Update conversation title in local state
                        setConversations(prev => prev.map(conv => 
                            conv.id === conversationId 
                                ? { ...conv, title: newTitle.trim() }
                                : conv
                        ));
                        setShowRenameModal(false);
                        setRenameValue('');
                        setRenameConversationId(null);
                    } else {
                        console.error('Failed to rename conversation');
                    }
                } catch (error) {
                    console.error('Error renaming conversation:', error);
                }
            };

            const hasMessages = messages.length > 0 || isLoading;
            
            // Debug logging
            console.log('hasMessages:', hasMessages, 'messages.length:', messages.length, 'isLoading:', isLoading);

            // Show loading screen while checking authentication
            if (authLoading) {
                return (
                    <div className="h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            // Redirect to auth page if not authenticated
            if (!isAuthenticated) {
                // Redirect immediately to auth page
                console.log('User not authenticated, redirecting to auth page');
                window.location.href = '/auth.html';
                return null;
            }

            return (
                <div className={`h-screen flex bg-gray-50 ${isKeyboardOpen ? 'keyboard-open' : ''}`}>
                    {/* Sidebar */}
                    <Sidebar
                        conversations={conversations}
                        currentConversationId={currentConversationId}
                        onSelectConversation={selectConversation}
                        onNewConversation={newConversation}
                        isMobileMenuOpen={isMobileMenuOpen}
                        setIsMobileMenuOpen={setIsMobileMenuOpen}
                        user={user}
                        onLogout={logout}
                        formatTimestamp={formatTimestamp}
                        isDarkMode={isDarkMode}
                        toggleDarkMode={toggleDarkMode}
                        setRenameConversationId={setRenameConversationId}
                        setRenameValue={setRenameValue}
                        setShowRenameModal={setShowRenameModal}
                        deleteConversation={deleteConversation}
                    />

                    {/* Main Chat Area */}
                    <div className="flex-1 flex flex-col lg:ml-0 main-chat-area" style={{ overflow: 'visible' }}>
                        {/* Header */}
                        <div className="px-3 sm:px-4 py-2 sm:py-3 relative mobile-header" style={{ zIndex: 9998, backgroundColor: 'var(--bg-primary)' }}>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-2 sm:space-x-3">
                                    {/* Mobile Menu Button - Left side */}
                                    <button
                                        onClick={() => {
                                            console.log('Mobile menu button clicked, current state:', isMobileMenuOpen);
                                            setIsMobileMenuOpen(!isMobileMenuOpen);
                                        }}
                                        className="lg:hidden p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors relative"
                                        style={{ zIndex: 9999, position: 'relative' }}
                                    >
                                        <i className="fas fa-bars"></i>
                                    </button>
                                    <div 
                                        className="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center cursor-pointer hover:bg-gray-100 rounded-lg transition-colors logo-container"
                                        onClick={() => {
                                            if (conversations.length > 0) {
                                                selectConversation(conversations[0].id);
                                            }
                                        }}
                                        title="Go to latest conversation"
                                    >
                                        <img 
                                            src="/static/icc_logo.svg" 
                                            alt="ICC Logo" 
                                            className="w-full h-full object-contain"
                                            onError={(e) => {
                                                e.target.style.display = 'none';
                                                e.target.nextSibling.style.display = 'flex';
                                            }}
                                        />
                                        <div className="w-full h-full bg-blue-500 rounded-full flex items-center justify-center" style={{display: 'none'}}>
                                            <i className="fas fa-robot text-white text-xs sm:text-sm"></i>
                                        </div>
                                    </div>
                                    <div className="hidden sm:block">
                                        <h1 className="text-base sm:text-lg font-semibold text-gray-800">ICC Legal Research Assistant</h1>
                                    </div>
                                    <div className="sm:hidden">
                                        <h1 className="text-sm font-semibold text-gray-800">ICC Legal Research</h1>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-2">
                                    {/* New Conversation Button */}
                                    <button
                                        onClick={newConversation}
                                        className="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 dark:text-gray-300 dark:hover:text-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                        title="Start New Conversation"
                                    >
                                        <i className="fas fa-plus"></i>
                                    </button>
                                    
                                    {/* Burger Menu */}
                                    <div className="relative header-menu-container">
                                        <button
                                            onClick={() => setShowHeaderMenu(!showHeaderMenu)}
                                            className="text-gray-600 hover:text-gray-800 hover:bg-gray-100 dark:text-gray-300 dark:hover:text-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center justify-center"
                                            title="Menu"
                                            style={{
                                                width: '32px',
                                                height: '32px',
                                                borderRadius: '50%',
                                                padding: '0',
                                                border: 'none',
                                                outline: 'none',
                                                background: 'transparent'
                                            }}
                                        >
                                            {/* Vertical dots on mobile, horizontal dots on desktop */}
                                            <i className="fas fa-ellipsis-v sm:hidden"></i>
                                            <i className="fas fa-ellipsis-h hidden sm:inline"></i>
                                        </button>
                                        
                                        {/* Header Menu Dropdown */}
                                        {showHeaderMenu && (
                                            <div className="absolute right-0 top-full mt-2 mr-2 w-48 bg-white dark:bg-gray-800 shadow-xl z-50" style={{ borderRadius: '16px' }}>
                                                <div className="py-1">
                                                    {/* Dark Mode Toggle */}
                                                    <button
                                                        onClick={() => {
                                                            setShowHeaderMenu(false);
                                                            toggleDarkMode();
                                                        }}
                                                        className="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center rounded-lg mx-1"
                                                        style={{ color: isDarkMode ? 'white' : '#374151' }}
                                                    >
                                                        <i className={`fas ${isDarkMode ? 'fa-sun' : 'fa-moon'} mr-2`} style={{ color: isDarkMode ? 'white' : '#374151' }}></i>
                                                        {isDarkMode ? 'Light Mode' : 'Dark Mode'}
                                                    </button>
                                                    
                                                    {/* Rename Conversation */}
                                                    {currentConversationId && (
                                                        <button
                                                            onClick={() => {
                                                                setShowHeaderMenu(false);
                                                                setShowRenameModal(true);
                                                            }}
                                                            className="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center rounded-lg mx-1"
                                                            style={{ color: isDarkMode ? 'white' : '#374151' }}
                                                        >
                                                            <i className="fas fa-pen mr-2" style={{ color: isDarkMode ? 'white' : '#374151' }}></i>
                                                            Rename Conversation
                                                        </button>
                                                    )}
                                                    
                                                    {/* Delete Conversation */}
                                                    {currentConversationId && currentConversation && currentConversation.title !== 'New Conversation' && currentConversation.messages && currentConversation.messages.length > 0 && (
                                                        <button
                                                            onClick={() => {
                                                                setShowHeaderMenu(false);
                                                                deleteConversation(currentConversationId);
                                                            }}
                                                            className="w-full text-left px-3 py-2 text-sm hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center rounded-lg mx-1"
                                                            style={{ color: '#ff8583' }}
                                                        >
                                                            <i className="fas fa-trash mr-2" style={{ color: '#ff8583' }}></i>
                                                            Delete Conversation
                                                        </button>
                                                    )}
                                                    
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Chat Content */}
                        {hasMessages ? (
                            <>
                                {/* Messages Container */}
                                <div className={`flex-1 overflow-y-auto py-4 sm:py-6 lg:py-8 messages-container mobile-messages-wrapper ${isKeyboardOpen ? 'keyboard-open' : ''}`}>
                                    <div className="max-w-xs sm:max-w-2xl lg:max-w-3xl mx-auto px-3 sm:px-4">
                                        {/* Mobile header spacer */}
                                        <div className="block sm:hidden h-6"></div>
                                        {messages.map((message) => (
                                            <ChatMessage
                                                key={message.id}
                                                message={message.text}
                                                isUser={message.isUser}
                                                style={message.style}
                                            />
                                        ))}
                                        {isLoading && (
                                            <ChatMessage
                                                message=""
                                                isUser={false}
                                                isLoading={true}
                                            />
                                        )}
                                        <div ref={messagesEndRef} />
                                    </div>
                                </div>

                                {/* Input */}
                                <div className={`chat-input-container ${isKeyboardOpen ? 'keyboard-open' : ''}`}>
                                    <ChatInput onSendMessage={sendMessage} isLoading={isLoading} hasUserInteracted={hasUserInteracted} />
                                </div>
                            </>
                        ) : (
                            /* Centered Input for New Conversations */
                            <ChatInput onSendMessage={sendMessage} isLoading={isLoading} isCentered={true} hasUserInteracted={hasUserInteracted} />
                        )}
                    </div>
                    
                    {/* Rename Modal */}
                    {showRenameModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
                                <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                    Rename Conversation
                                </h3>
                                <input
                                    type="text"
                                    value={renameValue}
                                    onChange={(e) => setRenameValue(e.target.value)}
                                    placeholder="Enter new conversation title"
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                    autoFocus
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') {
                                            renameConversation(renameConversationId || currentConversationId, renameValue);
                                        }
                                    }}
                                />
                                <div className="flex justify-end space-x-2 mt-4">
                                    <button
                                        onClick={() => {
                                            setShowRenameModal(false);
                                            setRenameValue('');
                                        }}
                                        className="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => renameConversation(renameConversationId || currentConversationId, renameValue)}
                                        disabled={!renameValue.trim()}
                                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                    >
                                        Rename
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<ChatApp />, document.getElementById('root'));
    </script>
</body>
</html>

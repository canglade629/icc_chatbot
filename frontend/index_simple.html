<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ICC Legal Research Assistant</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Simple markdown styling */
        .markdown-content {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            color: #374151;
            background-color: transparent;
        }
        
        .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            font-weight: bold;
            margin: 0.75rem 0 0.25rem 0;
        }
        
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.25rem; }
        .markdown-content h3 { font-size: 1.125rem; }
        .markdown-content h4 { font-size: 1rem; }
        .markdown-content h5 { font-size: 0.875rem; }
        .markdown-content h6 { font-size: 0.875rem; }
        
        .markdown-content p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .markdown-content li {
            margin: 0.25rem 0;
        }
        
        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .markdown-content pre {
            background-color: #f3f4f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 0.5rem 0;
            font-style: italic;
            color: #6b7280;
        }
        
        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        
        .markdown-content a:hover {
            color: #1d4ed8;
        }
        
        .markdown-content strong, .markdown-content b {
            font-weight: bold;
        }
        
        .markdown-content em, .markdown-content i {
            font-style: italic;
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.5rem 0;
        }
        
        .markdown-content th, .markdown-content td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .markdown-content th {
            background-color: #f9fafb;
            font-weight: bold;
        }
        
        /* Simple dark mode support */
        @media (prefers-color-scheme: dark) {
            .markdown-content {
                color: #e5e7eb;
            }
            
            .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 {
                color: #f9fafb;
            }
            
            .markdown-content code {
                background-color: #374151;
                color: #f9fafb;
            }
            
            .markdown-content pre {
                background-color: #374151;
                color: #f9fafb;
            }
            
            .markdown-content blockquote {
                border-left-color: #6b7280;
                color: #d1d5db;
            }
            
            .markdown-content th {
                background-color: #4b5563;
                color: #f9fafb;
            }
            
            .markdown-content td {
                border-bottom-color: #6b7280;
            }
        }
        
        /* Dark mode styles */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --sidebar-bg: #1f2937;
            --sidebar-text: #ffffff;
            --sidebar-hover: #374151;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --input-text: #111827;
            --message-user-bg: #dbeafe;
            --logo-bg: transparent;
        }
        
        [data-theme="dark"] {
            --bg-primary: #374151;
            --bg-secondary: #4b5563;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #6b7280;
            --sidebar-bg: #1f2937;
            --sidebar-text: #f1f5f9;
            --sidebar-hover: #374151;
            --input-bg: #4b5563;
            --input-border: #6b7280;
            --input-text: #f3f4f6;
            --message-user-bg: #1f2937;
            --logo-bg: #ffffff;
        }
        
        /* Apply theme variables */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .bg-gray-50 {
            background-color: var(--bg-primary) !important;
        }
        
        .bg-white {
            background-color: var(--bg-secondary) !important;
        }
        
        .text-gray-800 {
            color: var(--text-primary) !important;
        }
        
        .text-gray-600 {
            color: var(--text-secondary) !important;
        }
        
        .border-gray-300 {
            border-color: var(--border-color) !important;
        }
        
        .bg-gray-900 {
            background-color: var(--sidebar-bg) !important;
        }
        
        .text-white {
            color: var(--sidebar-text) !important;
        }
        
        .hover\\:bg-gray-800:hover {
            background-color: var(--sidebar-hover) !important;
        }
        
        .bg-gray-100 {
            background-color: var(--input-bg) !important;
        }
        
        .border-gray-300 {
            border-color: var(--input-border) !important;
        }
        
        .text-gray-900 {
            color: var(--input-text) !important;
        }
        
        .user-message {
            background-color: var(--message-user-bg) !important;
            border-radius: 20px !important;
            color: var(--text-primary) !important;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        function App() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [conversationId, setConversationId] = useState(null);
            const [isMobile, setIsMobile] = useState(false);
            const [isKeyboardOpen, setIsKeyboardOpen] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [conversations, setConversations] = useState([]);
            const [currentConversation, setCurrentConversation] = useState(null);
            
            const messagesEndRef = useRef(null);
            const textareaRef = useRef(null);
            const fileInputRef = useRef(null);
            
            // Check if mobile device
            useEffect(() => {
                const checkMobile = () => {
                    setIsMobile(window.innerWidth < 768);
                };
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);
            
            // Load conversations from localStorage
            useEffect(() => {
                const savedConversations = localStorage.getItem('icc_conversations');
                if (savedConversations) {
                    const parsed = JSON.parse(savedConversations);
                    setConversations(parsed);
                    if (parsed.length > 0) {
                        setCurrentConversation(parsed[0]);
                        setMessages(parsed[0].messages || []);
                        setConversationId(parsed[0].id);
                    }
                }
            }, []);
            
            // Save conversations to localStorage
            useEffect(() => {
                if (conversations.length > 0) {
                    localStorage.setItem('icc_conversations', JSON.stringify(conversations));
                }
            }, [conversations]);
            
            // Auto-scroll to bottom when new messages arrive
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);
            
            // Apply dark mode
            useEffect(() => {
                const savedTheme = localStorage.getItem('icc_theme');
                if (savedTheme) {
                    setIsDarkMode(savedTheme === 'dark');
                    document.documentElement.setAttribute('data-theme', savedTheme);
                } else {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    setIsDarkMode(prefersDark);
                    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                }
            }, []);
            
            const toggleDarkMode = () => {
                const newTheme = !isDarkMode;
                setIsDarkMode(newTheme);
                document.documentElement.setAttribute('data-theme', newTheme ? 'dark' : 'light');
                localStorage.setItem('icc_theme', newTheme ? 'dark' : 'light');
            };
            
            const newConversation = () => {
                const newConv = {
                    id: Date.now().toString(),
                    title: 'New Conversation',
                    messages: [],
                    createdAt: new Date().toISOString()
                };
                setConversations(prev => [newConv, ...prev]);
                setCurrentConversation(newConv);
                setMessages([]);
                setConversationId(newConv.id);
                setIsSidebarOpen(false);
            };
            
            const selectConversation = (conv) => {
                setCurrentConversation(conv);
                setMessages(conv.messages || []);
                setConversationId(conv.id);
                setIsSidebarOpen(false);
            };
            
            const deleteConversation = (convId) => {
                setConversations(prev => prev.filter(conv => conv.id !== convId));
                if (currentConversation && currentConversation.id === convId) {
                    newConversation();
                }
            };
            
            const sendMessage = async () => {
                if (!input.trim() || isLoading) return;
                
                const userMessage = { role: 'user', content: input.trim() };
                const newMessages = [...messages, userMessage];
                setMessages(newMessages);
                setInput('');
                setIsLoading(true);
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: input.trim(),
                            conversation_id: conversationId
                        }),
                    });
                    
                    if (!response.ok) {
                        if (response.status === 504) {
                            // Timeout error - AI is starting up
                            const timeoutMessage = { 
                                role: 'assistant', 
                                content: '⏳ The AI is starting up. Please wait about 30 seconds and try again.',
                                style: 'color: rgb(255, 133, 131);'
                            };
                            setMessages([...newMessages, timeoutMessage]);
                            return;
                        }
                        throw new Error('Failed to send message');
                    }
                    
                    const data = await response.json();
                    const assistantMessage = { role: 'assistant', content: data.response };
                    
                    const updatedMessages = [...newMessages, assistantMessage];
                    setMessages(updatedMessages);
                    
                    // Update conversation in conversations list
                    setConversations(prev => prev.map(conv => 
                        conv.id === conversationId 
                            ? { ...conv, messages: updatedMessages, title: updatedMessages[0]?.content?.substring(0, 50) + '...' || 'New Conversation' }
                            : conv
                    ));
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    const errorMessage = { 
                        role: 'assistant', 
                        content: (error.message.includes('timeout') || error.message.includes('Timeout') || error.name === 'TimeoutError')
                            ? '⏳ The AI is starting up. Please wait about 30 seconds and try again.'
                            : 'Sorry, I encountered an error. Please try again.',
                        style: (error.message.includes('timeout') || error.message.includes('Timeout') || error.name === 'TimeoutError')
                            ? 'color: rgb(255, 133, 131);'
                            : undefined
                    };
                    setMessages([...newMessages, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };
            
            const handleFocus = () => {
                if (isMobile) {
                    setIsKeyboardOpen(true);
                    setTimeout(() => {
                        textareaRef.current?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            };
            
            const handleBlur = () => {
                if (isMobile) {
                    setTimeout(() => {
                        setIsKeyboardOpen(false);
                    }, 300);
                }
            };
            
            const handleClick = () => {
                if (isMobile && textareaRef.current) {
                    textareaRef.current.focus();
                }
            };
            
            return (
                <div className="flex h-screen bg-gray-50">
                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 left-0 z-50 w-64 bg-gray-900 transform transition-transform duration-300 ease-in-out ${
                        isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                    } lg:translate-x-0 lg:static lg:inset-0`}>
                        <div className="flex items-center justify-between h-16 px-4 border-b border-gray-700">
                            <h1 className="text-lg font-semibold text-white">Conversations</h1>
                            <button
                                onClick={() => setIsSidebarOpen(false)}
                                className="lg:hidden text-gray-400 hover:text-white"
                            >
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto">
                            <div className="p-4">
                                <button
                                    onClick={newConversation}
                                    className="w-full px-4 py-2 mb-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    <i className="fas fa-plus mr-2"></i>
                                    New Conversation
                                </button>
                                <div className="space-y-2">
                                    {conversations.map((conv) => (
                                        <div key={conv.id} className="flex items-center group">
                                            <button
                                                onClick={() => selectConversation(conv)}
                                                className={`flex-1 px-3 py-2 text-left text-sm rounded-lg transition-colors ${
                                                    currentConversation?.id === conv.id
                                                        ? 'bg-gray-700 text-white'
                                                        : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                                }`}
                                            >
                                                {conv.title}
                                            </button>
                                            <button
                                                onClick={() => deleteConversation(conv.id)}
                                                className="ml-2 p-1 text-gray-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                                <i className="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Main Content */}
                    <div className="flex-1 flex flex-col">
                        {/* Header */}
                        <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center">
                                <button
                                    onClick={() => setIsSidebarOpen(true)}
                                    className="lg:hidden mr-3 text-gray-600 hover:text-gray-800"
                                >
                                    <i className="fas fa-bars"></i>
                                </button>
                                <div className="flex items-center">
                                    <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                                        <i className="fas fa-robot text-white text-sm"></i>
                                    </div>
                                    <h1 className="text-lg font-semibold text-gray-800">ICC Legal Research Assistant</h1>
                                </div>
                            </div>
                            <button
                                onClick={toggleDarkMode}
                                className="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors"
                            >
                                <i className={`fas ${isDarkMode ? 'fa-sun' : 'fa-moon'}`}></i>
                            </button>
                        </div>
                        
                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {messages.length === 0 ? (
                                <div className="text-center text-gray-500 mt-8">
                                    <i className="fas fa-comments text-4xl mb-4"></i>
                                    <p>Start a conversation by asking a legal question</p>
                                </div>
                            ) : (
                                messages.map((message, index) => (
                                    <div key={index} className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-3xl px-4 py-3 rounded-lg ${
                                            message.role === 'user' 
                                                ? 'user-message' 
                                                : 'bg-white border border-gray-200'
                                        }`}>
                                            {message.role === 'assistant' ? (
                                                <div 
                                                    className="markdown-content"
                                                    style={message.style ? { color: message.style.split(':')[1]?.trim() } : undefined}
                                                    dangerouslySetInnerHTML={{
                                                        __html: marked.parse(message.content)
                                                    }}
                                                />
                                            ) : (
                                                <p className="whitespace-pre-wrap">{message.content}</p>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                            {isLoading && (
                                <div className="flex justify-start">
                                    <div className="bg-white border border-gray-200 px-4 py-3 rounded-lg">
                                        <div className="flex items-center space-x-2">
                                            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                            <span className="text-gray-600">Thinking...</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        
                        {/* Input */}
                        <div className="bg-white border-t border-gray-200 p-4">
                            <div className="flex items-end space-x-2">
                                <div className="flex-1 relative">
                                    <textarea
                                        ref={textareaRef}
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyPress={handleKeyPress}
                                        onFocus={handleFocus}
                                        onBlur={handleBlur}
                                        onClick={handleClick}
                                        placeholder="Ask a legal question..."
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        rows="1"
                                        style={{
                                            minHeight: '48px',
                                            maxHeight: '120px',
                                            resize: 'none'
                                        }}
                                        onInput={(e) => {
                                            e.target.style.height = 'auto';
                                            e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
                                        }}
                                    />
                                </div>
                                <button
                                    onClick={sendMessage}
                                    disabled={!input.trim() || isLoading}
                                    className="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                >
                                    <i className="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
